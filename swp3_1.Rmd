---
title: "Special Work Performance 3: Reducing Data Complexity"
author: 'Natalie und Julia'
geometry: margin=2cm
output: 
  pdf_document:
    fig_caption: true
    keep_tex: yes
sansfont: times
fontsize: 12pt
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

options(repos=c(CRAN = "https://cran.uni-muenster.de/"))
```

\begin{center}
Humboldt University Berlin 

course name und semester
by Prof. Dr. xxxxxxx 

\textbf{Group x:}\\  
\textbf{XXXXX}, 12345; 
\textbf{XXXXX}, 84579; \\
Submitted on November xx, xxxx 

\end{center}

```{r dataset, echo=FALSE}
## set environment
wdir <- "C:\\Users\\Natalie\\Dropbox\\WiSe201718\\Customer Analytics and Customer Insights\\Data"
setwd(wdir)
install.packages("psych"); library(psych)

## functions
std_rank <- function(x){
  return(sum(x)/(50*7))
}

## Reading data, once table "Attribute Rating", twice "Direct Preference Rating"
bars <- read.csv("attribute_evaluation_choc_bars.csv", sep = ";", header = TRUE)
rating <- read.csv("bars_rating.csv", sep = ";", header = TRUE)

rank <- list()
rating$Person <- NULL
rank <- sort(round(sapply(rating, std_rank), digits = 2), decreasing = TRUE)

## Cleaning sample bars
bars_mean <- list()
bars_mean <- sapply(na.omit(bars), mean)

for(col in 1:length(bars)) {
  #bars[[paste(col, "missing", sep = "_")]] <- ifelse(is.na(bars[[col]]), 1, 0)
  bars[[col]] <- ifelse(is.na(bars[[col]]), bars_mean[col], bars[[col]])
}
```

## Introduction of the Data Set "Chocolate Bars"

The given data set is about 10 different chocolate bar products. Four tables organize the accquired data in the tables "General Consumption", "Direct Preference Rating", "Attribute Rating" and "Social Demographic Questions". 15 participants evaluate 10 different choclate bars by 13 attributes. The participants rate directly their preferences of the chocolate bars on a scale from 1 till 7. The most popular bar is "Kinderriegel", the least popular one "Mars" as shown in figure 1.

```{r rank, echo=FALSE, fig.cap="Figure 1: Rank of the 10 chocolat products"}
# main : rankings of chocolat bars
rank <- sort(round(sapply(rating, std_rank), digits = 2), decreasing = TRUE)
```

## Describing the Attributes of the Chocolate Bars

# Factor Analysis

The data reduction technique Factor Analysis investigates the relationships of the attributes by collapsing a large number of variables into a few interpretable underlying factors, the latent variables. The participants weight multiple variables similar because they belong to the same latent variable. The question that should be answered with factor analysis in the following analysis is "What are the important attributes in general?". The findings show which factors the consumers like and which should be improved. 
Firstly, the data set is cleaned and analyzed before using the factor analysis function. The data set "Attribute Rating", which contains the evaluation of each attribute per chocolat bar on a scale from 1 till 5 from 50 participants, is loaded and cleaned. The cleaning program calculates the attribute's mean over all 10 chocolate products. The result is a 50 by 13 matrix.  

Factor analysis assign each variable to a latent variable, the factor, based on their correlation. The value of the eigenvalues of the data set as a matrix show how many variables the eigenvector explains. Fig. B1 shows the eigenvalue of each variable. 5 variables have a eigenvalue > 1. The model has a good fit with 5 or less factors.

```{r eigenvalue, echo=FALSE, fig.cap="Fig. B1: Sorted list of the eigenvalues of the Participants-Attribute Matrix"}
if(!require("tidyverse")) install.packages("tidyverse"); library("tidyverse") # load the package
if(!require("lavaan")) install.packages("lavaan",dependencies=T); library("lavaan") # load the package
if(!require("semTools")) install.packages("semTools", dependencies=T); library("semTools") # load the package
# if(!require("semPlot")) install.packages("semPlot", dependencies=T); library("semPlot") # load the package
if(!require("psych")) install.packages("psych", dependencies=T); library("psych") # load the package
if(!require("car")) install.packages("car", dependencies=T); library("car") # load the package
if(!require("RColorBrewer")) install.packages("RColorBrewer", dependencies=T); library("RColorBrewer") # load the package

attributeRating_df <- read.csv("attribute_evaluation_choc_bars.csv", sep = ";", header = TRUE)

attributeRating_df <- attributeRating_df %>% 
  gather(k, v, -Person) %>% 
  separate(k, c("brand","b"), sep =  "_") %>% 
  spread(b, v, fill = "") %>% 
  arrange(brand)

attributeRating_df[, 3:15] <- sapply(attributeRating_df[, 3:15], as.numeric)
attributeRating_df$brand<-factor(attributeRating_df$brand)
levels(attributeRating_df$brand)<-c("Snickers", "Kinder Bueno", "Twix", "Mars", "KitKat",
                                    "Bounty", "Kinder Riegel", "Balisto Korn-Mix", "Lion",
                                    "Duplo")

#summary(attributeRating_df[, 3:15])
describe(attributeRating_df[, 3:15], na.rm = TRUE)

sort(round(eigen(cor(attributeRating_df[,3:15], use = "complete.obs"))$values, 2), decreasing = TRUE) #result: 5 factors EV > 1
```

# Report Results

The model best fit is with 4 factors, using the method "minres" and the orthogonal rotation model. One variable is assigned to one factor with the lower theshold at 0.3. The first factor induces the attributes image, commercial and wrapping. The assigned name is "Packaging". The second factor induces the attributes sweet, chocolaty and creamy. The assigned name is "Taste". The third factor induces the attributes addiction and rich, the name of the factor is "Frequency of eating". The fourth factor induces the variables handy, accessible and calorie. The assigned name is "Usability". The attribute "calorie" is assigned with 0.3 which explains the weak explanation fit to the factor "Usabilty". The attributes crunchy and healthful have no assignment to one factor, hence they are neglected. Fig. B3 shows the scores of the first two factors "Packaging" and "Taste". 

```{r fa, echo=FALSE, fig.cap="Fig. B2: Factor scores of the factors "Packaging" and "Taste"}
pies.fa <- fa(attributeRating_df[3:15], missing = TRUE, nfactors = 4, rotate = "varimax", cut = 0.3)
fa.diagram(pies.fa)
fa.scores <- data.frame(pies.fa$scores)[,1:2]
round(fa.scores, 2)
```

# Interpret results
